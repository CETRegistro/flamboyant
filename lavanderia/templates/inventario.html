{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>Inventário de itens de Flamboyant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container-fluid p-2">
    <h1 class="mb-4">Inventário</h1>

    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Categoria</th>
                    <th>Quantidade</th>                    
                    <th>Tamanho</th>
                    <th>Observações</th>
                    <th>Criado em</th>
                    <th>Atualizado em</th>
                    <th>Retornou</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventario %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.categoria.nome }}</td>
                    <td>{{ item.quantidade }}</td>                    
                    <td>{{ item.tamanho }}</td>
                    <td>{{ item.observacoes|default:"-" }}</td>
                    <td>{{ item.criado_em|date:"d/m/Y H:i" }}</td>
                    <td>{{ item.atualizado_em|date:"d/m/Y H:i" }}</td>
                    <td>
                        <div class="input-group input-group-sm">
                        <input type="number" name="retornou_{{ item.id }}" class="form-control" min="0" value="{{ item.quantidade|default:0 }}"> 
                        <button type="button" class="btn btn-primary salvar-item" data-item-id="{{ item.id }}">Salvar</button>
                    </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="text-center">Nenhum item encontrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        $('.salvar-item').on('click', function() {
            var itemId = $(this).data('item-id');
            var valorRetornou = $('input[name="retornou_' + itemId + '"]').val();

            $.ajax({
                url: '{% url "criar_servico" %}',
                type: 'POST',
                data: {
                    'item_id': itemId,
                    'retornou': valorRetornou,
                    'csrfmiddlewaretoken': csrftoken
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('Item ' + itemId + ' salvo com sucesso: ' + response.message);
                        // Recarrega a página após o sucesso
                        location.reload();
                    } else {
                        alert('Erro ao salvar o item ' + itemId + ': ' + response.message);
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Erro desconhecido.';
                    try {
                        const errorResponse = JSON.parse(xhr.responseText);
                        errorMessage = errorResponse.message || errorMessage;
                    } catch (e) {
                        errorMessage = xhr.responseText || errorMessage;
                    }
                    alert('Erro ao salvar o item ' + itemId + ': ' + errorMessage);
                }
            });
        });
    });
</script>

</body>
</html>